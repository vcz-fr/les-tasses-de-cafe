var gdjs;(function(c){const n=new c.Logger("PIXI Image manager"),u=(o,e)=>{n.error("Unable to load file "+o+" with error:",e||"(unknown error)")},d=(o,e)=>{!o||e.smoothed||(o.baseTexture.scaleMode=PIXI.SCALE_MODES.NEAREST)},h=(o,e)=>{e&&!e.smoothed&&(o.magFilter=THREE.NearestFilter,o.minFilter=THREE.NearestFilter)},l=(o,e,r)=>{const t=o.get(e);return t&&t.kind===r?t:null};class x{constructor(e,r){this._resources=new Map,this.setResources(e),this._resourcesLoader=r,this._invalidTexture=PIXI.Texture.from("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAFElEQVQoU2P8z/D/PwMewDgyFAAApMMX8Zi0uXAAAAAASUVORK5CYIIA"),this._loadedTextures=new Hashtable,this._loadedThreeTextures=new Hashtable,this._loadedThreeMaterials=new Hashtable}setResources(e){this._resources.clear();for(const r of e)(r.kind==="image"||r.kind==="video")&&this._resources.set(r.name,r)}getPIXITexture(e){if(this._loadedTextures.containsKey(e)){const a=this._loadedTextures.get(e);if(a.valid)return a;n.error("Texture for "+e+" is not valid anymore (or never was).")}if(e==="")return this._invalidTexture;const r=l(this._resources,e,"image");if(!r)return n.warn('Unable to find texture for resource "'+e+'".'),this._invalidTexture;n.log('Loading texture for resource "'+e+'"...');const t=r.file,s=PIXI.Texture.from(this._resourcesLoader.getFullUrl(t),{resourceOptions:{crossorigin:this._resourcesLoader.checkIfCredentialsRequired(t)?"use-credentials":"anonymous"}}).on("error",a=>{u(t,a)});return d(s,r),this._loadedTextures.put(e,s),s}getThreeTexture(e){const r=this._loadedThreeTextures.get(e);if(r)return r;const t=this.getPIXITexture(e);if(!this._resourcesLoader._runtimeGame.getRenderer().getPIXIRenderer())throw new Error("No PIXI renderer was found.");const a=t.baseTexture.resource.source;if(!(a instanceof HTMLImageElement))throw new Error(`Can't load texture for resource "${e}" as it's not an image.`);const i=new THREE.Texture(a);i.magFilter=THREE.LinearFilter,i.minFilter=THREE.LinearFilter,i.wrapS=THREE.RepeatWrapping,i.wrapT=THREE.RepeatWrapping,i.colorSpace=THREE.SRGBColorSpace,i.needsUpdate=!0;const T=l(this._resources,e,"image");return h(i,T),this._loadedThreeTextures.put(e,i),i}getThreeMaterial(e,{useTransparentTexture:r,forceBasicMaterial:t}){const s=`${e}|${r?1:0}|${t?1:0}`,a=this._loadedThreeMaterials.get(s);if(a)return a;const i=t?new THREE.MeshBasicMaterial({map:this.getThreeTexture(e),side:r?THREE.DoubleSide:THREE.FrontSide,transparent:r}):new THREE.MeshStandardMaterial({map:this.getThreeTexture(e),side:r?THREE.DoubleSide:THREE.FrontSide,transparent:r,metalness:0});return this._loadedThreeMaterials.put(s,i),i}getPIXIVideoTexture(e){if(this._loadedTextures.containsKey(e))return this._loadedTextures.get(e);if(e==="")return this._invalidTexture;const r=l(this._resources,e,"video");if(!r)return n.warn('Unable to find video texture for resource "'+e+'".'),this._invalidTexture;const t=r.file;n.log('Loading video texture for resource "'+e+'"...');const s=PIXI.Texture.from(this._resourcesLoader.getFullUrl(t),{resourceOptions:{crossorigin:this._resourcesLoader.checkIfCredentialsRequired(t)?"use-credentials":"anonymous",autoPlay:!1}}).on("error",a=>{u(t,a)});return this._loadedTextures.put(e,s),s}getInvalidPIXITexture(){return this._invalidTexture}async loadTextures(e){let r=0;return await Promise.all([...this._resources.values()].map(async t=>{try{if(t.kind==="video")await new Promise((s,a)=>{const i=PIXI.Texture.from(this._resourcesLoader.getFullUrl(t.file),{resourceOptions:{crossOrigin:this._resourcesLoader.checkIfCredentialsRequired(t.file)?"use-credentials":"anonymous",autoPlay:!1}}).on("error",g=>{a(g)});i.baseTexture.on("loaded",()=>{this._loadedTextures.put(t.name,i),d(i,t),s()})});else{PIXI.Assets.setPreferences({preferWorkers:!1,preferCreateImageBitmap:!1,crossOrigin:this._resourcesLoader.checkIfCredentialsRequired(t.file)?"use-credentials":"anonymous"});const s=await PIXI.Assets.load(t.file);this._loadedTextures.put(t.name,s),d(s,t)}}catch(s){u(t.file,s)}r++,e(r,this._resources.size)})),r}}c.PixiImageManager=x,c.ImageManager=c.PixiImageManager})(gdjs||(gdjs={}));
//# sourceMappingURL=pixi-image-manager.js.map
